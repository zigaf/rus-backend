const express = require('express');
const cors = require('cors');
const { Pool } = require('pg');

const app = express();
const PORT = process.env.PORT || 3001;

// PostgreSQL connection
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// Test database connection
async function testDatabaseConnection() {
  try {
    const client = await pool.connect();
    console.log('‚úÖ Database connected successfully');
    client.release();
  } catch (error) {
    console.error('‚ùå Database connection failed:', error.message);
    console.log('üîß Using mock data instead');
  }
}

// CORS configuration
app.use(cors({
  origin: ['https://rus-production.up.railway.app', 'http://localhost:4200'],
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    server: 'postgres-backend',
    database: pool ? 'connected' : 'disconnected',
    message: 'Backend is running successfully!'
  });
});

app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    server: 'postgres-backend',
    database: pool ? 'connected' : 'disconnected',
    message: 'API is working!'
  });
});

// Simple auth endpoint
app.post('/api/auth/login', (req, res) => {
  const { email, password } = req.body;
  
  // Simple hardcoded admin check
  if (email === 'admin@ruslana.com' && password === 'admin123') {
    res.json({
      token: 'fake-jwt-token-for-testing',
      user: {
        id: 1,
        email: 'admin@ruslana.com',
        role: 'ADMIN'
      }
    });
  } else {
    res.status(401).json({ error: 'Invalid credentials' });
  }
});

// Get current user endpoint
app.get('/api/auth/me', (req, res) => {
  res.json({
    user: {
      id: 1,
      email: 'admin@ruslana.com',
      role: 'ADMIN'
    }
  });
});

// Articles endpoint with database
app.get('/api/articles', async (req, res) => {
  try {
    // Try to get articles from database
    const result = await pool.query('SELECT * FROM "Article" WHERE published = true ORDER BY "createdAt" DESC');
    
    if (result.rows.length > 0) {
      res.json(result.rows);
      return;
    }
  } catch (error) {
    console.log('üìù Using mock articles (database not available)');
  }
  
  // Fallback to mock data
  const articles = [
    {
      id: 1,
      title: '–†–∞–∫ –ª–µ–≥–µ–Ω—å: —Ä–∞–Ω–Ω—ñ –æ–∑–Ω–∞–∫–∏ —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
      excerpt: '–†–∞–∫ –ª–µ–≥–µ–Ω—å - –æ–¥–Ω–µ –∑ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö –æ–Ω–∫–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω—å. –î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –ø—Ä–æ –ø–µ—Ä—à—ñ —Å–∏–º–ø—Ç–æ–º–∏ —Ç–∞ —Å—É—á–∞—Å–Ω—ñ –º–µ—Ç–æ–¥–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.',
      category: '–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
      image: 'https://images.unsplash.com/photo-1631217868264-e5b90bb7e133?w=800&h=600&fit=crop',
      date: '15 –±–µ—Ä–µ–∑–Ω—è 2025',
      readTime: '7 —Ö–≤',
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      content: {
        intro: '–†–∞–∫ –ª–µ–≥–µ–Ω—å –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –æ–¥–Ω–∏–º –∑ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö –æ–Ω–∫–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω—å.',
        sections: [
          { heading: '–°–∏–º–ø—Ç–æ–º–∏', text: '–ö–∞—à–µ–ª—å, –∑–∞–¥–∏—à–∫–∞, –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö.' }
        ]
      }
    },
    {
      id: 2,
      title: '–°—É—á–∞—Å–Ω—ñ –º–µ—Ç–æ–¥–∏ –ª—ñ–∫—É–≤–∞–Ω–Ω—è —Ä–∞–∫—É –ª–µ–≥–µ–Ω—å',
      excerpt: '–í—ñ–¥ —Ö—ñ—Ä—É—Ä–≥—ñ—á–Ω–æ–≥–æ –≤—Ç—Ä—É—á–∞–Ω–Ω—è –¥–æ —Ç–∞—Ä–≥–µ—Ç–Ω–æ—ó —Ç–µ—Ä–∞–ø—ñ—ó - –æ–≥–ª—è–¥ –Ω–∞–π–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ –ª—ñ–∫—É–≤–∞–Ω–Ω—è –æ–Ω–∫–æ–ª–æ–≥—ñ—ó –ª–µ–≥–µ–Ω—å.',
      category: '–õ—ñ–∫—É–≤–∞–Ω–Ω—è',
      image: 'https://images.unsplash.com/photo-1579684385127-1ef15d508118?w=800&h=600&fit=crop',
      date: '10 –±–µ—Ä–µ–∑–Ω—è 2025',
      readTime: '8 —Ö–≤',
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      content: {
        intro: '–°—É—á–∞—Å–Ω—ñ –º–µ—Ç–æ–¥–∏ –ª—ñ–∫—É–≤–∞–Ω–Ω—è.',
        sections: [
          { heading: '–•—ñ—Ä—É—Ä–≥—ñ—è', text: '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è.' }
        ]
      }
    },
    {
      id: 3,
      title: '–ü—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∞ —Ä–∞–∫—É –ª–µ–≥–µ–Ω—å',
      excerpt: '–í–∞–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–¥–º–æ–≤–∏ –≤—ñ–¥ –∫—É—Ä—ñ–Ω–Ω—è, —Ä–µ–≥—É–ª—è—Ä–Ω–∏—Ö –æ–±—Å—Ç–µ–∂–µ–Ω—å —Ç–∞ –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–ø–æ—Å–æ–±—É –∂–∏—Ç—Ç—è –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∏ —Ä–∞–∫—É –ª–µ–≥–µ–Ω—å.',
      category: '–ü—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∞',
      image: 'https://images.unsplash.com/photo-1505576399279-565b52d4ac71?w=800&h=600&fit=crop',
      date: '5 –±–µ—Ä–µ–∑–Ω—è 2025',
      readTime: '6 —Ö–≤',
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      content: {
        intro: '–ü—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∞ —Ä–∞–∫—É –ª–µ–≥–µ–Ω—å.',
        sections: [
          { heading: '–ö—É—Ä—ñ–Ω–Ω—è', text: '–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–∫—Ç–æ—Ä —Ä–∏–∑–∏–∫—É.' }
        ]
      }
    }
  ];
  
  res.json(articles);
});

// Get single article
app.get('/api/articles/:id', async (req, res) => {
  const articleId = parseInt(req.params.id);
  
  try {
    // Try to get article from database
    const result = await pool.query('SELECT * FROM "Article" WHERE id = $1 AND published = true', [articleId]);
    
    if (result.rows.length > 0) {
      res.json(result.rows[0]);
      return;
    }
  } catch (error) {
    console.log('üìù Using mock article (database not available)');
  }
  
  // Fallback to mock data
  const articles = [
    {
      id: 1,
      title: '–†–∞–∫ –ª–µ–≥–µ–Ω—å: —Ä–∞–Ω–Ω—ñ –æ–∑–Ω–∞–∫–∏ —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
      excerpt: '–†–∞–∫ –ª–µ–≥–µ–Ω—å - –æ–¥–Ω–µ –∑ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö –æ–Ω–∫–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω—å.',
      category: '–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
      image: 'https://images.unsplash.com/photo-1631217868264-e5b90bb7e133?w=800&h=600&fit=crop',
      date: '15 –±–µ—Ä–µ–∑–Ω—è 2025',
      readTime: '7 —Ö–≤',
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      content: {
        intro: '–†–∞–∫ –ª–µ–≥–µ–Ω—å –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –æ–¥–Ω–∏–º –∑ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö –æ–Ω–∫–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω—å.',
        sections: [
          { heading: '–°–∏–º–ø—Ç–æ–º–∏', text: '–ö–∞—à–µ–ª—å, –∑–∞–¥–∏—à–∫–∞, –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö.' }
        ]
      }
    }
  ];
  
  const article = articles.find(a => a.id === articleId);
  if (article) {
    res.json(article);
  } else {
    res.status(404).json({ error: 'Article not found' });
  }
});

// Create new article
app.post('/api/articles', async (req, res) => {
  const { title, excerpt, category, image, content, published = true } = req.body;
  
  try {
    // Try to save to database
    const result = await pool.query(
      'INSERT INTO "Article" (title, excerpt, category, image, content, published, "createdAt", "updatedAt") VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING *',
      [title, excerpt, category, image, JSON.stringify(content), published, new Date(), new Date()]
    );
    
    console.log('‚úÖ Article saved to database:', result.rows[0].id);
    res.json(result.rows[0]);
    return;
  } catch (error) {
    console.log('üìù Article saved to mock (database not available):', error.message);
  }
  
  // Fallback: return success but don't actually save
  const newArticle = {
    id: Date.now(),
    title,
    excerpt,
    category,
    image,
    content,
    published,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  
  res.json(newArticle);
});

// Update article
app.put('/api/articles/:id', async (req, res) => {
  const articleId = parseInt(req.params.id);
  const { title, excerpt, category, image, content, published } = req.body;
  
  try {
    // Try to update in database
    const result = await pool.query(
      'UPDATE "Article" SET title = $1, excerpt = $2, category = $3, image = $4, content = $5, published = $6, "updatedAt" = $7 WHERE id = $8 RETURNING *',
      [title, excerpt, category, image, JSON.stringify(content), published, new Date(), articleId]
    );
    
    if (result.rows.length > 0) {
      console.log('‚úÖ Article updated in database:', articleId);
      res.json(result.rows[0]);
      return;
    }
  } catch (error) {
    console.log('üìù Article update failed (database not available):', error.message);
  }
  
  // Fallback: return success
  res.json({ id: articleId, message: 'Article updated (mock mode)' });
});

// Delete article
app.delete('/api/articles/:id', async (req, res) => {
  const articleId = parseInt(req.params.id);
  
  try {
    // Try to delete from database
    const result = await pool.query('DELETE FROM "Article" WHERE id = $1 RETURNING *', [articleId]);
    
    if (result.rows.length > 0) {
      console.log('‚úÖ Article deleted from database:', articleId);
      res.json({ message: 'Article deleted successfully' });
      return;
    }
  } catch (error) {
    console.log('üìù Article deletion failed (database not available):', error.message);
  }
  
  // Fallback: return success
  res.json({ message: 'Article deleted (mock mode)' });
});

// Gallery endpoint with database
app.get('/api/gallery', async (req, res) => {
  try {
    // Try to get gallery images from database
    const result = await pool.query('SELECT * FROM "GalleryImage" WHERE published = true ORDER BY "order" ASC');
    
    if (result.rows.length > 0) {
      res.json(result.rows);
      return;
    }
  } catch (error) {
    console.log('üñºÔ∏è Using mock gallery (database not available)');
  }
  
  // Fallback to mock data
  const galleryImages = [
    {
      id: 1,
      title: '–ú–µ–¥–∏—á–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è',
      description: '–°—É—á–∞—Å–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∞ –ª—ñ–∫—É–≤–∞–Ω–Ω—è',
      imageUrl: 'https://images.unsplash.com/photo-1551076805-e1869033e561?w=800&h=600&fit=crop',
      imageType: 'image',
      order: 1,
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    },
    {
      id: 2,
      title: '–•—ñ—Ä—É—Ä–≥—ñ—á–Ω–∏–π –∫–∞–±—ñ–Ω–µ—Ç',
      description: '–°—É—á–∞—Å–Ω–∏–π —Ö—ñ—Ä—É—Ä–≥—ñ—á–Ω–∏–π –∫–∞–±—ñ–Ω–µ—Ç',
      imageUrl: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=800&h=600&fit=crop',
      imageType: 'image',
      order: 2,
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    },
    {
      id: 3,
      title: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è',
      description: '–°—É—á–∞—Å–Ω–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—ñ–≤',
      imageUrl: 'https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?w=800&h=600&fit=crop',
      imageType: 'image',
      order: 3,
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    }
  ];
  
  res.json(galleryImages);
});

// Get single gallery image
app.get('/api/gallery/:id', async (req, res) => {
  const imageId = parseInt(req.params.id);
  
  try {
    // Try to get gallery image from database
    const result = await pool.query('SELECT * FROM "GalleryImage" WHERE id = $1 AND published = true', [imageId]);
    
    if (result.rows.length > 0) {
      res.json(result.rows[0]);
      return;
    }
  } catch (error) {
    console.log('üñºÔ∏è Using mock gallery image (database not available)');
  }
  
  // Fallback to mock data
  const galleryImages = [
    {
      id: 1,
      title: '–ú–µ–¥–∏—á–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è',
      description: '–°—É—á–∞—Å–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∞ –ª—ñ–∫—É–≤–∞–Ω–Ω—è',
      imageUrl: 'https://images.unsplash.com/photo-1551076805-e1869033e561?w=800&h=600&fit=crop',
      imageType: 'image',
      order: 1,
      published: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    }
  ];
  
  const image = galleryImages.find(img => img.id === imageId);
  if (image) {
    res.json(image);
  } else {
    res.status(404).json({ error: 'Image not found' });
  }
});

// Contact endpoint
app.post('/api/contact', async (req, res) => {
  const { name, email, message } = req.body;
  
  console.log('New contact message:', { name, email, message });
  
  try {
    // Try to save to database
    await pool.query(
      'INSERT INTO "ContactMessage" (name, email, message, "createdAt", "updatedAt") VALUES ($1, $2, $3, $4, $5)',
      [name, email, message, new Date(), new Date()]
    );
    console.log('‚úÖ Contact message saved to database');
  } catch (error) {
    console.log('üìù Contact message logged (database not available)');
  }
  
  res.json({
    success: true,
    message: 'Message sent successfully'
  });
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    error: {
      message: err.message || 'Internal Server Error',
      details: process.env.NODE_ENV === 'development' ? err.stack : undefined,
    },
  });
});

// 404 handler
app.use('*', (req, res) => {
  res.status(404).json({
    error: {
      message: 'Route not found',
      path: req.originalUrl
    }
  });
});

// Start server
app.listen(PORT, '0.0.0.0', async () => {
  console.log(`üöÄ PostgreSQL Backend Server running on port ${PORT}`);
  console.log(`üîó Health check: http://0.0.0.0:${PORT}/health`);
  console.log(`üìä Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`üåê CORS enabled for: https://rus-production.up.railway.app`);
  
  // Test database connection
  await testDatabaseConnection();
});

// Handle server errors
process.on('uncaughtException', (error) => {
  console.error('‚ùå Uncaught Exception:', error);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);
});

// Graceful shutdown
process.on('SIGINT', async () => {
  console.log('\nüõë Shutting down gracefully...');
  await pool.end();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('\nüõë Shutting down gracefully...');
  await pool.end();
  process.exit(0);
});
